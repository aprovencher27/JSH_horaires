<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaire JSH Montr√©al-Centre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1E3A8A;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: #1E3A8A;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.reload {
            background: #1E3A8A;
        }

        .current-month {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 0 20px;
        }

        .ics-manager {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
        }

        .ics-manager h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.2em;
        }

        .ics-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ics-item {
            background: white;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .ics-item.active {
            border-color: var(--calendar-color);
            background: rgba(var(--calendar-color-rgb), 0.1);
        }

        .ics-item.loading {
            opacity: 0.6;
        }

        .ics-item.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 15px;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top: 2px solid #C41E3A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ics-checkbox {
            margin: 0;
            transform: scale(1.3);
            flex-shrink: 0;
        }

        .ics-details {
            flex: 1;
            min-width: 0;
        }

        .ics-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ics-status {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .calendar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .calendar-container {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .time-slot {
            height: 60px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .time-slot:first-child {
            height: 60px;
            background: #1E3A8A;
            color: white;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex: 1;
        }

        .day-column {
            border-right: 1px solid #dee2e6;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            background: #1E3A8A;
            color: white;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .day-header.today {
            background: linear-gradient(45deg, #ffc107, #ff8f00);
        }

        .day-name {
            font-size: 12px;
            opacity: 0.9;
        }

        .day-number {
            font-size: 18px;
            font-weight: bold;
        }

        .time-grid {
            position: relative;
        }

        .hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 60px;
            border-bottom: 1px solid #e9ecef;
        }

        .hour-line:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }

        .event {
            position: absolute;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            line-height: 1.1;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            word-wrap: break-word;
        }

        .event:hover {
            transform: translateX(-1px) scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 20;
        }

        .event-time {
            font-weight: bold;
            display: block;
            margin-bottom: 1px;
            font-size: 9px;
        }

        .event-title {
            opacity: 0.95;
            font-size: 9px;
            display: block;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .week-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .week-info {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffe6e6;
            color: #d63384;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .status-indicator.loaded {
            background-color: #28a745;
        }

        .status-indicator.loading {
            background-color: #ffc107;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                gap: 15px;
            }

            .sidebar {
                width: 100%;
                order: -1;
            }

            .ics-manager {
                position: static;
            }

            .ics-list {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }

            .ics-item {
                flex: 1;
                min-width: 200px;
                padding: 10px;
                font-size: 12px;
            }
            
            .controls {
                justify-content: center;
                text-align: center;
            }
            
            .current-month {
                margin: 10px 0;
                order: -1;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .time-slot {
                font-size: 10px;
                height: 40px;
            }

            .time-slot:first-child {
                height: 40px;
            }

            .hour-line {
                height: 40px;
            }

            .event {
                font-size: 9px;
            }

            .calendar-container {
                overflow-x: auto;
            }

            .ics-list {
                flex-direction: column;
            }

            .ics-item {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="ics-manager">
                <h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="toggleAllCalendars()" id="toggleAllBtn" style="padding: 8px 12px; font-size: 12px;">
                            Tout cocher
                        </button>
                        <button class="btn reload" onclick="reloadAllCalendars()" id="reloadBtn" style="padding: 8px 12px;">
                            üîÑ
                        </button>
                    </div>
                </h3>
                <div class="ics-list" id="icsList"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Horaire JSH Montr√©al-Centre</h1>
                
                <div class="controls">
                    <div class="nav-buttons">
                        <button class="btn" onclick="previousWeek()">‚Äπ Semaine pr√©c√©dente</button>
                        <button class="btn" onclick="nextWeek()">Semaine suivante ‚Ä∫</button>
                        <button class="btn" onclick="goToToday()">Cette semaine</button>
                    </div>
                    <div class="current-month" id="currentMonth"></div>
                    <div class="week-info" id="weekInfo"></div>
                </div>
            </div>

            <div class="calendar">
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>
    </div>

   <script>
        class ICSCalendar {
            constructor() {
                this.currentDate = new Date();
                this.currentWeekStart = this.getWeekStart(new Date()); // Garder trace du d√©but de semaine
                this.events = [];
                this.icsCalendars = [];
                // Plage horaire fixe de 7h √† 23h
                this.minHour = 7;
                this.maxHour = 23;
                
                // Mode arenas
                this.isArenaMode = false;
                
                // Configuration du r√©pertoire GitHub
                this.repoConfig = {
                    owner: 'jsh-mtl-centre',
                    repo: 'horaire',
                    branch: 'main'
                };
                
                // Palette de couleurs pour les calendriers
                this.colorPalette = [
                    '#667eea', '#e74c3c', '#2ecc71', '#f39c12', 
                    '#9b59b6', '#1abc9c', '#e67e22', '#34495e',
                    '#f1c40f', '#e91e63', '#00bcd4', '#ff5722',
                    '#795548', '#607d8b', '#8bc34a', '#ffc107',
                    // Nouvelles couleurs ajout√©es
                    '#3f51b5', '#ff9800', '#4caf50', 
                    '#9c27b0', '#00acc1', '#ff7043', '#546e7a',
                    '#cddc39', '#ec407a', '#26c6da', '#ff6f00',
                    '#8d6e63', '#78909c', '#689f38', '#ffb300'
                ];
                
                this.init();
            }

            async init() {
                this.render();
                this.renderIcsList();
                this.updateModeButton();
                await this.discoverIcsFiles();
                await this.loadAllCalendars();
            }

            async toggleMode() {
                this.isArenaMode = !this.isArenaMode;
                this.updateModeButton();
                // Red√©couvrir les fichiers et recharger compl√®tement
                await this.discoverIcsFiles();
                await this.loadAllCalendars();
            }

            updateModeButton() {
                const modeBtn = document.getElementById('reloadBtn');
                if (modeBtn) {
                    modeBtn.textContent = this.isArenaMode ? 'Mode groupes' : 'Mode arenas';
                }
            }

            async discoverIcsFiles() {
                const modeBtn = document.getElementById('reloadBtn');
                modeBtn.disabled = true;
                
                try {
                    const currentPath = this.isArenaMode ? 'ics_arenas' : 'ics_groupes';
                    console.log(`D√©couverte des fichiers .ics dans le r√©pertoire ${currentPath}...`);
                    
                    // URL de l'API GitHub pour lister les fichiers
                    const apiUrl = `https://api.github.com/repos/${this.repoConfig.owner}/${this.repoConfig.repo}/contents/${currentPath}?ref=${this.repoConfig.branch}`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`Erreur API GitHub: ${response.status}`);
                    }
                    
                    const files = await response.json();
                    console.log(`${files.length} fichiers trouv√©s dans le r√©pertoire`);
                    
                    // Filtrer les fichiers .ics
                    const icsFiles = files.filter(file => 
                        file.type === 'file' && 
                        file.name.toLowerCase().endsWith('.ics')
                    );
                    
                    console.log(`${icsFiles.length} fichiers .ics trouv√©s:`, icsFiles.map(f => f.name));
                    
                    if (icsFiles.length === 0) {
                        const modeText = this.isArenaMode ? 'arenas' : 'groupes';
                        throw new Error(`Aucun fichier .ics trouv√© dans le r√©pertoire ${currentPath} (mode ${modeText})`);
                    }
                    
                    // Cr√©er la liste des calendriers avec leurs pr√©f√©rences sauvegard√©es
                    this.icsCalendars = icsFiles.map((file, index) => {
                        const calendarName = this.formatCalendarName(file.name);
                        const savedState = this.loadCalendarPreferences();
                        
                        return {
                            url: file.download_url,
                            name: calendarName,
                            fileName: file.name,
                            active: savedState[calendarName] !== undefined ? savedState[calendarName] : true,
                            color: this.colorPalette[index % this.colorPalette.length],
                            events: [],
                            status: 'loading'
                        };
                    });
                    
                } catch (error) {
                    console.error('Erreur lors de la d√©couverte des fichiers:', error);
                    this.showError(`Erreur lors de la d√©couverte des fichiers: ${error.message}`);
                    this.icsCalendars = []; // Pas de fallback
                }
                
                this.renderIcsList();
                this.updateToggleAllButton();
                modeBtn.disabled = false;
            }

            formatCalendarName(fileName) {
                // Supprimer l'extension .ics
                let name = fileName.replace(/\.ics$/i, '');
                
                // Remplacer les underscores par des espaces
                name = name.replace(/_/g, ' ');
                
                // Capitaliser chaque mot
                name = name.replace(/\b\w/g, l => l.toUpperCase());
                
                return name;
            }

            async loadAllCalendars() {
                const modeBtn = document.getElementById('reloadBtn');
                modeBtn.disabled = true;
                
                if (this.icsCalendars.length === 0) {
                    console.log('Aucun calendrier √† charger');
                    modeBtn.disabled = false;
                    return;
                }
                
                const promises = this.icsCalendars.map(calendar => this.loadIcsData(calendar));
                await Promise.all(promises);
                
                modeBtn.disabled = false;
                this.updateEvents();
                this.render();
                this.renderIcsList();
            }

            async loadIcsData(calendar) {
                calendar.status = 'loading';
                this.renderIcsList();
                
                try {
                    console.log(`Chargement du calendrier: ${calendar.name}`);
                    console.log(`URL: ${calendar.url}`);
                    
                    // Essayer d'abord directement
                    let response;
                    try {
                        response = await fetch(calendar.url);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (error) {
                        console.log('√âchec de la requ√™te directe, utilisation du proxy CORS...');
                        // Utiliser un proxy CORS si la requ√™te directe √©choue
                        response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(calendar.url)}`);
                        if (!response.ok) {
                            throw new Error(`Proxy HTTP ${response.status}`);
                        }
                    }
                    
                    const icsText = await response.text();
                    console.log(`Donn√©es ICS re√ßues pour ${calendar.name}:`, icsText.substring(0, 200) + '...');
                    
                    calendar.events = this.parseICS(icsText);
                    calendar.status = 'loaded';
                    
                    console.log(`${calendar.events.length} √©v√©nements trouv√©s pour ${calendar.name}`);
                    
                } catch (error) {
                    console.error(`Erreur lors du chargement de ${calendar.name}:`, error);
                    calendar.status = 'error';
                    calendar.events = [];
                    this.showError(`Erreur lors du chargement de ${calendar.name}: ${error.message}`);
                }
                
                this.renderIcsList();
            }

            parseICS(icsText) {
                const events = [];
                const lines = icsText.split(/\r?\n/).map(line => line.trim());
                let currentEvent = null;
                let multiLineProperty = null;

                console.log(`D√©but du parsing ICS, ${lines.length} lignes √† traiter`);

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];

                    // Gestion des propri√©t√©s multi-lignes
                    if (multiLineProperty && (line.startsWith(' ') || line.startsWith('\t'))) {
                        multiLineProperty.value += line.substring(1);
                        continue;
                    } else if (multiLineProperty) {
                        this.processProperty(currentEvent, multiLineProperty.key, multiLineProperty.value);
                        multiLineProperty = null;
                    }

                    if (line === 'BEGIN:VEVENT') {
                        currentEvent = {};
                        console.log('D√©but d\'un nouvel √©v√©nement');
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.dtstart && currentEvent.summary) {
                            events.push(currentEvent);
                            console.log(`√âv√©nement ajout√©: ${currentEvent.summary} le ${currentEvent.dtstart}`);
                        }
                        currentEvent = null;
                    } else if (currentEvent && line.includes(':')) {
                        const colonIndex = line.indexOf(':');
                        const key = line.substring(0, colonIndex);
                        const value = line.substring(colonIndex + 1);

                        if (value.length === 0 || line.endsWith('\\')) {
                            // Propri√©t√© multi-ligne
                            multiLineProperty = { key, value };
                        } else {
                            this.processProperty(currentEvent, key, value);
                        }
                    }
                }

                console.log(`Parsing termin√©, ${events.length} √©v√©nements trouv√©s`);
                return events;
            }

            processProperty(event, key, value) {
                if (key === 'SUMMARY') {
                    event.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, '\n');
                } else if (key.startsWith('DTSTART')) {
                    event.dtstart = this.parseICSDate(value);
                    event.allDay = !key.includes('TZID') && !value.includes('T');
                } else if (key.startsWith('DTEND')) {
                    event.dtend = this.parseICSDate(value);
                } else if (key === 'DESCRIPTION') {
                    event.description = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, '\n');
                }
            }

            parseICSDate(dateStr) {
                // Formats: YYYYMMDD, YYYYMMDDTHHMMSS, YYYYMMDDTHHMMSSZ
                if (!dateStr || dateStr.length < 8) {
                    return new Date();
                }

                const year = parseInt(dateStr.substr(0, 4));
                const month = parseInt(dateStr.substr(4, 2)) - 1;
                const day = parseInt(dateStr.substr(6, 2));

                if (dateStr.length > 8 && dateStr.includes('T')) {
                    const timeStr = dateStr.split('T')[1];
                    const hour = parseInt(timeStr.substr(0, 2));
                    const minute = parseInt(timeStr.substr(2, 2));
                    const second = timeStr.length >= 6 ? parseInt(timeStr.substr(4, 2)) : 0;
                    
                    return new Date(year, month, day, hour, minute, second);
                } else {
                    return new Date(year, month, day);
                }
            }

            updateEvents() {
                this.events = [];
                this.icsCalendars.forEach(calendar => {
                    if (calendar.active && calendar.status === 'loaded') {
                        calendar.events.forEach(event => {
                            this.events.push({
                                ...event,
                                color: calendar.color,
                                calendar: calendar.name
                            });
                        });
                    }
                });
                
                console.log(`Total des √©v√©nements actifs: ${this.events.length}`);
                console.log(`Plage horaire fixe: ${this.minHour}:00 - ${this.maxHour}:00`);
            }

            toggleCalendar(index) {
                this.icsCalendars[index].active = !this.icsCalendars[index].active;
                this.saveCalendarPreferences();
                this.updateEvents();
                this.render();
                this.renderIcsList();
                this.updateToggleAllButton();
            }

            toggleAllCalendars() {
                const allChecked = this.icsCalendars.every(cal => cal.active);
                
                this.icsCalendars.forEach(calendar => {
                    calendar.active = !allChecked;
                });
                
                this.saveCalendarPreferences();
                this.updateEvents();
                this.render();
                this.renderIcsList();
                this.updateToggleAllButton();
            }

            updateToggleAllButton() {
                const toggleBtn = document.getElementById('toggleAllBtn');
                if (!toggleBtn) return;
                
                const allChecked = this.icsCalendars.every(cal => cal.active);
                const allUnchecked = this.icsCalendars.every(cal => !cal.active);
                
                if (allChecked) {
                    toggleBtn.textContent = 'Tout d√©cocher';
                } else if (allUnchecked) {
                    toggleBtn.textContent = 'Tout cocher';
                } else {
                    toggleBtn.textContent = 'Tout d√©cocher';
                }
            }

            saveCalendarPreferences() {
                const preferences = {};
                this.icsCalendars.forEach(calendar => {
                    preferences[calendar.name] = calendar.active;
                });
                localStorage.setItem('calendarPreferences', JSON.stringify(preferences));
                console.log('Pr√©f√©rences sauvegard√©es:', preferences);
            }

            loadCalendarPreferences() {
                try {
                    const saved = localStorage.getItem('calendarPreferences');
                    if (saved) {
                        const preferences = JSON.parse(saved);
                        console.log('Pr√©f√©rences charg√©es:', preferences);
                        return preferences;
                    }
                } catch (error) {
                    console.warn('Erreur lors du chargement des pr√©f√©rences:', error);
                }
                return {};
            }

            renderIcsList() {
                const icsList = document.getElementById('icsList');
                icsList.innerHTML = '';

                this.icsCalendars.forEach((calendar, index) => {
                    const item = document.createElement('div');
                    item.className = `ics-item ${calendar.active ? 'active' : ''} ${calendar.status === 'loading' ? 'loading' : ''}`;
                    item.style.setProperty('--calendar-color', calendar.color);
                    item.style.setProperty('--calendar-color-rgb', this.hexToRgb(calendar.color));
                    
                    const statusIndicator = this.getStatusIndicator(calendar.status);
                    const statusText = calendar.status === 'loading' ? 'chargement...' : 
                                     calendar.status === 'error' ? 'erreur' : '';

                    item.innerHTML = `
                        <input type="checkbox" class="ics-checkbox" 
                               ${calendar.active ? 'checked' : ''} 
                               onchange="window.calendar.toggleCalendar(${index})">
                        <div class="ics-details">
                            <div class="ics-name" style="color: ${calendar.color}">
                                ${calendar.name}
                                ${statusIndicator}
                            </div>
                            <div class="ics-status">${statusText}</div>
                        </div>
                    `;
                    icsList.appendChild(item);
                });
            }

            getStatusIndicator(status) {
                return `<span class="status-indicator ${status}"></span>`;
            }

            hexToRgb(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `${r}, ${g}, ${b}`;
            }

            getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajuster pour commencer lundi
                d.setDate(diff);
                d.setHours(0, 0, 0, 0); // Reset time to start of day
                return d;
            }

            previousWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                this.currentDate = new Date(this.currentWeekStart); // Sync currentDate
                this.render();
            }

            nextWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                this.currentDate = new Date(this.currentWeekStart); // Sync currentDate
                this.render();
            }

            goToToday() {
                const today = new Date();
                this.currentWeekStart = this.getWeekStart(today);
                this.currentDate = new Date(this.currentWeekStart);
                this.render();
            }

            render() {
                this.renderWeekHeader();
                //this.renderTimeColumn();
                this.renderWeekGrid();
            }

            renderWeekHeader() {
                const weekEnd = new Date(this.currentWeekStart);
                weekEnd.setDate(this.currentWeekStart.getDate() + 6);

                const monthNames = [
                    'janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                    'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'
                ];

                // Format: "29 septembre au 5 octobre"
                let weekText;
                if (this.currentWeekStart.getMonth() === weekEnd.getMonth()) {
                    weekText = `${this.currentWeekStart.getDate()} au ${weekEnd.getDate()} ${monthNames[this.currentWeekStart.getMonth()]}`;
                } else {
                    weekText = `${this.currentWeekStart.getDate()} ${monthNames[this.currentWeekStart.getMonth()]} au ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]}`;
                }

                document.getElementById('currentMonth').textContent = weekText;
                document.getElementById('weekInfo').textContent = '';
            }

            renderWeekGrid() {
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';
                
                // Modifier le grid pour avoir 8 colonnes : heures + 7 jours
                grid.style.gridTemplateColumns = '80px repeat(7, 1fr)';

                const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Premi√®re colonne : en-t√™te des heures
                const timeHeaderColumn = document.createElement('div');
                timeHeaderColumn.style.borderRight = '2px solid #dee2e6';
                timeHeaderColumn.style.background = '#f8f9fa';
                
                // En-t√™te "Heure"
                const timeHeader = document.createElement('div');
                timeHeader.style.height = '60px';
                timeHeader.style.background = '#1E3A8A';
                timeHeader.style.color = 'white';
                timeHeader.style.display = 'flex';
                timeHeader.style.alignItems = 'center';
                timeHeader.style.justifyContent = 'center';
                timeHeader.style.fontWeight = 'bold';
                timeHeader.style.fontSize = '14px';
                timeHeader.textContent = 'Heure';
                timeHeaderColumn.appendChild(timeHeader);

                // Cr√©neaux horaires
                const totalHours = this.maxHour - this.minHour + 1;
                for (let i = 0; i < totalHours; i++) {
                    const hour = this.minHour + i;
                    const timeSlot = document.createElement('div');
                    timeSlot.style.height = '60px';
                    timeSlot.style.borderBottom = '1px solid #e9ecef';
                    timeSlot.style.display = 'flex';
                    timeSlot.style.alignItems = 'center';
                    timeSlot.style.justifyContent = 'center';
                    timeSlot.style.fontSize = '12px';
                    timeSlot.style.color = '#666';
                    timeSlot.style.fontWeight = '500';
                    timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    timeHeaderColumn.appendChild(timeSlot);
                }
                grid.appendChild(timeHeaderColumn);

                // Colonnes des jours
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(this.currentWeekStart);
                    currentDate.setDate(this.currentWeekStart.getDate() + i);

                    const dayColumn = document.createElement('div');
                    dayColumn.style.borderRight = i === 6 ? 'none' : '1px solid #dee2e6';
                    dayColumn.style.position = 'relative';

                    // En-t√™te du jour
                    const dayHeader = document.createElement('div');
                    dayHeader.style.background = '#1E3A8A';
                    dayHeader.style.color = 'white';
                    dayHeader.style.padding = '15px 5px';
                    dayHeader.style.textAlign = 'center';
                    dayHeader.style.fontWeight = 'bold';
                    dayHeader.style.fontSize = '14px';
                    dayHeader.style.height = '60px';
                    dayHeader.style.display = 'flex';
                    dayHeader.style.flexDirection = 'column';
                    dayHeader.style.alignItems = 'center';
                    dayHeader.style.justifyContent = 'center';
                    
                    const currentDateOnly = new Date(currentDate);
                    currentDateOnly.setHours(0, 0, 0, 0);
                    
                    if (currentDateOnly.getTime() === today.getTime()) {
                        dayHeader.style.background = 'linear-gradient(45deg, #ffc107, #ff8f00)';
                    }

                    dayHeader.innerHTML = `
                        <div style="font-size: 12px; opacity: 0.9;">${dayNames[i]}</div>
                        <div style="font-size: 18px; font-weight: bold;">${currentDate.getDate()}</div>
                    `;
                    dayColumn.appendChild(dayHeader);

                    // Grille horaire
                    const timeGrid = document.createElement('div');
                    timeGrid.style.position = 'relative';
                    timeGrid.style.height = `${totalHours * 60}px`;

                    // Lignes horaires
                    for (let j = 0; j < totalHours; j++) {
                        const hourLine = document.createElement('div');
                        hourLine.style.position = 'absolute';
                        hourLine.style.left = '0';
                        hourLine.style.right = '0';
                        hourLine.style.height = '60px';
                        hourLine.style.borderBottom = '1px solid #e9ecef';
                        hourLine.style.top = `${j * 60}px`;
                        if (j % 2 === 1) {
                            hourLine.style.backgroundColor = 'rgba(0,0,0,0.02)';
                        }
                        timeGrid.appendChild(hourLine);
                    }

                    // √âv√©nements
                    const dayEvents = this.getEventsForDate(currentDate);
                    const overlappingGroups = this.detectOverlaps(dayEvents);
                    const eventOverlapMap = new Map();
                    
                    overlappingGroups.forEach(group => {
                        group.forEach(event => {
                            eventOverlapMap.set(event, group);
                        });
                    });
                    
                    dayEvents.forEach(event => {
                        const overlaps = eventOverlapMap.get(event) || [];
                        const eventElement = this.createEventElement(event, overlaps);
                        if (eventElement) {
                            timeGrid.appendChild(eventElement);
                        }
                    });

                    dayColumn.appendChild(timeGrid);
                    grid.appendChild(dayColumn);
                }
            }

            createEventElement(event, overlaps = []) {
                const eventElement = document.createElement('div');
                eventElement.className = 'event';
                eventElement.style.backgroundColor = event.color;

                const startTime = new Date(event.dtstart);
                let endTime;
                
                if (event.dtend) {
                    endTime = new Date(event.dtend);
                } else if (event.allDay) {
                    // √âv√©nement toute la journ√©e - s'√©tend sur toute la plage visible
                    endTime = new Date(startTime);
                    endTime.setHours(this.maxHour, 59, 59);
                    startTime.setHours(this.minHour, 0, 0);
                } else {
                    // Dur√©e par d√©faut d'1 heure
                    endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
                }

                // Calculer la position et la hauteur relative √† la plage horaire fixe (7h-23h)
                const startMinutes = (startTime.getHours() - this.minHour) * 60 + startTime.getMinutes();
                const endMinutes = (endTime.getHours() - this.minHour) * 60 + endTime.getMinutes();
                const duration = Math.max(endMinutes - startMinutes, 15); // Minimum 15 minutes

                // Ne pas afficher les √©v√©nements compl√®tement en dehors de la plage 7h-23h
                if (endTime.getHours() < this.minHour || startTime.getHours() > this.maxHour) {
                    return null;
                }

                // Ajuster les √©v√©nements qui d√©bordent de la plage
                const adjustedStartMinutes = Math.max(0, startMinutes);
                const maxMinutes = (this.maxHour - this.minHour + 1) * 60;
                const adjustedEndMinutes = Math.min(maxMinutes, endMinutes);
                const adjustedDuration = Math.max(adjustedEndMinutes - adjustedStartMinutes, 15);

                eventElement.style.top = `${adjustedStartMinutes}px`;
                eventElement.style.height = `${adjustedDuration}px`;

                // Gestion des superpositions
                const totalOverlaps = overlaps.length;
                const eventIndex = overlaps.indexOf(event);
                
                if (totalOverlaps > 0) {
                    const width = 100 / totalOverlaps;
                    const leftOffset = (100 / totalOverlaps) * eventIndex;
                    
                    eventElement.style.width = `${width}%`;
                    eventElement.style.left = `${leftOffset}%`;
                    eventElement.style.right = 'auto';
                } else {
                    eventElement.style.left = '2px';
                    eventElement.style.right = '2px';
                    eventElement.style.width = 'auto';
                }

                // Contenu de l'√©v√©nement
                const timeStr = event.allDay ? 'Toute la journ√©e' : 
                    `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')}`;

                const endTimeStr = event.allDay ? '' : 
                    ` - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;

                eventElement.innerHTML = `
                    <span class="event-time">${timeStr}${endTimeStr}</span>
                    <span class="event-title">${event.summary}</span>
                `;

                eventElement.title = `${event.summary}\nCalendrier: ${event.calendar}\nHeure: ${timeStr}${endTimeStr}\nDate: ${startTime.toLocaleDateString('fr-FR')}`;

                return eventElement;
            }

            // Fonction pour d√©tecter les superpositions
            detectOverlaps(events) {
                const overlappingGroups = [];
                
                for (let i = 0; i < events.length; i++) {
                    const event1 = events[i];
                    const start1 = new Date(event1.dtstart);
                    const end1 = event1.dtend ? new Date(event1.dtend) : 
                                 event1.allDay ? new Date(start1.getTime() + 24 * 60 * 60 * 1000) :
                                 new Date(start1.getTime() + 60 * 60 * 1000);
                    
                    // Trouver tous les √©v√©nements qui se chevauchent avec celui-ci
                    const overlappingEvents = [event1];
                    
                    for (let j = i + 1; j < events.length; j++) {
                        const event2 = events[j];
                        const start2 = new Date(event2.dtstart);
                        const end2 = event2.dtend ? new Date(event2.dtend) : 
                                     event2.allDay ? new Date(start2.getTime() + 24 * 60 * 60 * 1000) :
                                     new Date(start2.getTime() + 60 * 60 * 1000);
                        
                        // V√©rifier s'il y a chevauchement
                        if (start1 < end2 && start2 < end1) {
                            overlappingEvents.push(event2);
                        }
                    }
                    
                    if (overlappingEvents.length > 1) {
                        // V√©rifier si ce groupe n'existe pas d√©j√† 
                        const existingGroup = overlappingGroups.find(group => 
                            group.some(e => e === event1)
                        );
                        
                        if (!existingGroup) {
                            overlappingGroups.push(overlappingEvents);
                        }
                    }
                }
                
                return overlappingGroups;
            }

            getEventsForDate(date) {
                const dateOnly = new Date(date);
                dateOnly.setHours(0, 0, 0, 0);
                
                return this.events.filter(event => {
                    if (!event.dtstart) return false;
                    const eventDate = new Date(event.dtstart);
                    eventDate.setHours(0, 0, 0, 0);
                    return eventDate.getTime() === dateOnly.getTime();
                });
            }

            showError(message) {
                console.error(message);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.ics-manager').appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 10000);
            }
        }

        // Initialiser le calendrier
        window.calendar = new ICSCalendar();

        // Fonctions globales
        function previousWeek() {
            window.calendar.previousWeek();
        }

        function nextWeek() {
            window.calendar.nextWeek();
        }

        function goToToday() {
            window.calendar.goToToday();
        }

        function toggleAllCalendars() {
            window.calendar.toggleAllCalendars();
        }

        async function reloadAllCalendars() {
            // Changer de mode (arenas/groupes)
            await window.calendar.toggleMode();
        }
    </script>
</body>
</html>