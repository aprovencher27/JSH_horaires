<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaires</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            background-color: #f8f9fa;
            padding: 10px;
        }
        
        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        
        .header select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .checkbox-container label {
            font-size: 14px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .events-table th,
        .events-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .events-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }
        
        .events-table tr:hover {
            background: #f8f9fa;
        }
        
        .events-table tr.past-event {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .day-column {
            font-weight: 600;
            color: #007bff;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .datetime-column {
            white-space: nowrap;
            font-family: monospace;
            font-size: 13px;
        }
        
        .duration-column {
            white-space: nowrap;
            color: #6c757d;
            font-size: 13px;
        }
        
        .summary-column {
            font-weight: 500;
        }
        
        .description-column {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .location-column {
            color: #6c757d;
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .no-events {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
            background: white;
            border-radius: 8px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .header select {
                min-width: auto;
                width: 100%;
            }
            
            .events-table {
                font-size: 12px;
            }
            
            .events-table th,
            .events-table td {
                padding: 8px 4px;
            }
            
            .description-column {
                max-width: 120px;
            }
            
            .location-column {
                max-width: 100px;
            }
            
            /* Masquer certaines colonnes sur mobile très petit */
            @media (max-width: 480px) {
                .description-column,
                .location-column {
                    display: none;
                }
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <select id="groupSelect" onchange="filterEvents()">
            <option value="all">Tous les groupes</option>
        </select>
        
        <div class="checkbox-container">
            <input type="checkbox" id="showPastEvents" onchange="filterEvents()">
            <label for="showPastEvents">Afficher les événements passés</label>
        </div>
    </div>
    
    <div id="eventsContainer">
        <div class="loading">Chargement des événements...</div>
    </div>

    <script>
        const repoConfig = {
            owner: 'jsh-mtl-centre',
            repo: 'horaire',
            branch: 'main'
        };
        
        let allEvents = [];
        let calendars = [];

        // Démarrer automatiquement au chargement de la page
        window.addEventListener('load', loadCalendars);

        async function loadCalendars() {
            try {
                // Charger le fichier JSON généré par GitHub Actions
                const response = await fetch(`https://${repoConfig.owner}.github.io/${repoConfig.repo}/calendars.json`);
                
                if (!response.ok) {
                    throw new Error(`Erreur lors du chargement: ${response.status}`);
                }
                
                const calendarsData = await response.json();
                
                // Traiter les calendriers de groupes et arenas
                allEvents = [];
                calendars = [];
                
                // Ajouter les groupes
                for (const file of calendarsData.groupes) {
                    const calendar = {
                        name: file.name,
                        fileName: file.fileName,
                        url: `https://${repoConfig.owner}.github.io/${repoConfig.repo}/ics_groupes/${file.fileName}`,
                        events: []
                    };
                    calendars.push(calendar);
                    
                    try {
                        await loadCalendarEvents(calendar);
                        calendar.events.forEach(event => {
                            event.calendarName = calendar.name;
                        });
                        allEvents.push(...calendar.events);
                    } catch (error) {
                        console.error(`Erreur pour ${calendar.name}:`, error);
                    }
                }
                
                // Ajouter les arenas
                for (const file of calendarsData.arenas) {
                    const calendar = {
                        name: file.name,
                        fileName: file.fileName,
                        url: `https://${repoConfig.owner}.github.io/${repoConfig.repo}/ics_arenas/${file.fileName}`,
                        events: []
                    };
                    calendars.push(calendar);
                    
                    try {
                        await loadCalendarEvents(calendar);
                        calendar.events.forEach(event => {
                            event.calendarName = calendar.name;
                        });
                        allEvents.push(...calendar.events);
                    } catch (error) {
                        console.error(`Erreur pour ${calendar.name}:`, error);
                    }
                }
                
                // Trier tous les événements par date
                allEvents.sort((a, b) => a.startDate - b.startDate);
                
                // Peupler le menu déroulant et afficher les événements
                populateGroupSelect();
                filterEvents();
                
            } catch (error) {
                console.error('Erreur:', error);
                showError(`Erreur: ${error.message}`);
            }
        }

        async function loadCalendarEvents(calendar) {
            const response = await fetch(calendar.url);
            if (!response.ok) {
                throw new Error(`Erreur lors du téléchargement: ${response.status}`);
            }
            
            const icsData = await response.text();
            calendar.events = parseIcsData(icsData);
        }

        function unescapeIcsText(text) {
            if (!text) return text;
            return text
                .replace(/\\,/g, ',')
                .replace(/\\;/g, ';')
                .replace(/\\n/g, '\n')
                .replace(/\\N/g, '\n')
                .replace(/\\\\/g, '\\');
        }

        function parseIcsData(icsData) {
            const events = [];
            const lines = icsData.split('\n');
            let currentEvent = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.dtstart && currentEvent.dtend) {
                        currentEvent.startDate = parseIcsDate(currentEvent.dtstart);
                        currentEvent.endDate = parseIcsDate(currentEvent.dtend);
                        currentEvent.isPast = currentEvent.endDate < new Date();
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const [key, ...valueParts] = line.split(':');
                    const value = unescapeIcsText(valueParts.join(':'));
                    
                    switch (key.split(';')[0]) {
                        case 'DTSTART':
                            currentEvent.dtstart = valueParts.join(':'); // Ne pas unescape les dates
                            break;
                        case 'DTEND':
                            currentEvent.dtend = valueParts.join(':'); // Ne pas unescape les dates
                            break;
                        case 'SUMMARY':
                            currentEvent.summary = value;
                            break;
                        case 'DESCRIPTION':
                            currentEvent.description = value;
                            break;
                        case 'LOCATION':
                            currentEvent.location = value;
                            break;
                    }
                }
            }
            
            return events;
        }

        function parseIcsDate(dateString) {
            const cleanDate = dateString.replace(/[TZ]/g, '');
            const year = parseInt(cleanDate.substring(0, 4));
            const month = parseInt(cleanDate.substring(4, 6)) - 1;
            const day = parseInt(cleanDate.substring(6, 8));
            const hour = parseInt(cleanDate.substring(8, 10)) || 0;
            const minute = parseInt(cleanDate.substring(10, 12)) || 0;
            const second = parseInt(cleanDate.substring(12, 14)) || 0;
            
            return new Date(year, month, day, hour, minute, second);
        }

        function populateGroupSelect() {
            const select = document.getElementById('groupSelect');
            
            calendars.forEach(calendar => {
                const option = document.createElement('option');
                option.value = calendar.name;
                option.textContent = calendar.name;
                select.appendChild(option);
            });
        }

        function filterEvents() {
            const selectedGroup = document.getElementById('groupSelect').value;
            const showPast = document.getElementById('showPastEvents').checked;
            
            let filteredEvents = allEvents;
            
            // Filtrer par groupe
            if (selectedGroup !== 'all') {
                filteredEvents = filteredEvents.filter(event => event.calendarName === selectedGroup);
            }
            
            // Filtrer les événements passés
            if (!showPast) {
                filteredEvents = filteredEvents.filter(event => !event.isPast);
            }
            
            renderEvents(filteredEvents);
        }

        function renderEvents(events) {
            const container = document.getElementById('eventsContainer');
            
            if (events.length === 0) {
                container.innerHTML = '<div class="no-events">Aucun événement trouvé</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'events-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Jour</th>
                        <th>Date/Heure</th>
                        <th>Durée</th>
                        <th>Résumé</th>
                        <th class="description-column">Description</th>
                        <th class="location-column">Lieu</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            events.forEach(event => {
                const row = document.createElement('tr');
                if (event.isPast) {
                    row.classList.add('past-event');
                }
                
                const dayOfWeek = getDayOfWeek(event.startDate);
                const dateTime = formatDateTime(event.startDate);
                const duration = formatDuration(event.startDate, event.endDate);
                const summary = event.summary || 'Sans titre';
                const description = event.description || '';
                const location = event.location || '';
                
                row.innerHTML = `
                    <td class="day-column">${dayOfWeek}</td>
                    <td class="datetime-column">${dateTime}</td>
                    <td class="duration-column">${duration}</td>
                    <td class="summary-column">${escapeHtml(summary)}</td>
                    <td class="description-column" title="${escapeHtml(description)}">${escapeHtml(description)}</td>
                    <td class="location-column" title="${escapeHtml(location)}">${escapeHtml(location)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function getDayOfWeek(date) {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            return days[date.getDay()];
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function formatDuration(startDate, endDate) {
            const durationMs = endDate - startDate;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h${minutes > 0 ? ` ${minutes}m` : ''}`;
            } else {
                return `${minutes}m`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>