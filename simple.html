<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner ICS GitHub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .scan-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .scan-btn:hover {
            background: #0056b3;
        }
        
        .scan-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #007bff;
            color: white;
        }
        
        .filter-btn:hover {
            background: #e9ecef;
        }
        
        .filter-btn.active:hover {
            background: #0056b3;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .events-table th,
        .events-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .events-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .events-table tr:hover {
            background: #f8f9fa;
        }
        
        .events-table tr.past-event {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .day-column {
            font-weight: bold;
            color: #007bff;
            white-space: nowrap;
        }
        
        .datetime-column {
            white-space: nowrap;
            font-family: monospace;
        }
        
        .duration-column {
            white-space: nowrap;
            color: #6c757d;
        }
        
        .summary-column {
            font-weight: bold;
        }
        
        .description-column {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .location-column {
            color: #6c757d;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .no-events {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Scanner de fichiers ICS GitHub</h1>
        <button class="scan-btn" id="scanBtn" onclick="scanIcsFiles()">Scanner les fichiers ICS</button>
    </div>
    
    <div class="filter-section" id="filterSection">
        <h3>Filtrer par calendrier:</h3>
        <div class="filter-buttons" id="filterButtons"></div>
        <div id="eventsCount"></div>
    </div>
    
    <div id="eventsContainer"></div>

    <script>
        const repoConfig = {
            owner: 'jsh-mtl-centre',
            repo: 'horaire',
            branch: 'main'
        };
        
        let allEvents = [];
        let activeFilters = new Set();

        async function scanIcsFiles() {
            const scanBtn = document.getElementById('scanBtn');
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scan en cours...';
            
            try {
                await discoverIcsFiles();
                await loadAllCalendars();
                setupFilters();
                renderEvents();
            } catch (error) {
                console.error('Erreur:', error);
                showError(`Erreur: ${error.message}`);
            }
            
            scanBtn.disabled = false;
            scanBtn.textContent = 'Scanner les fichiers ICS';
        }

        async function discoverIcsFiles() {
            const currentPath = 'ics_groupes';
            console.log(`Découverte des fichiers .ics dans le répertoire ${currentPath}...`);
            
            const apiUrl = `https://api.github.com/repos/${repoConfig.owner}/${repoConfig.repo}/contents/${currentPath}?ref=${repoConfig.branch}`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`Erreur API GitHub: ${response.status}`);
            }
            
            const files = await response.json();
            
            const icsFiles = files.filter(file => 
                file.type === 'file' && 
                file.name.toLowerCase().endsWith('.ics')
            );
            
            if (icsFiles.length === 0) {
                throw new Error(`Aucun fichier .ics trouvé dans le répertoire ${currentPath}`);
            }
            
            window.icsCalendars = icsFiles.map((file) => ({
                url: file.download_url,
                name: formatCalendarName(file.name),
                fileName: file.name,
                events: []
            }));
        }

        function formatCalendarName(fileName) {
            return fileName.replace('.ics', '').replace(/_/g, ' ');
        }

        async function loadAllCalendars() {
            allEvents = [];
            
            for (const calendar of window.icsCalendars) {
                try {
                    await loadCalendarEvents(calendar);
                    // Ajouter le nom du calendrier à chaque événement
                    calendar.events.forEach(event => {
                        event.calendarName = calendar.name;
                    });
                    allEvents.push(...calendar.events);
                } catch (error) {
                    console.error(`Erreur pour ${calendar.name}:`, error);
                }
            }
            
            // Trier tous les événements par date
            allEvents.sort((a, b) => a.startDate - b.startDate);
        }

        async function loadCalendarEvents(calendar) {
            const response = await fetch(calendar.url);
            if (!response.ok) {
                throw new Error(`Erreur lors du téléchargement: ${response.status}`);
            }
            
            const icsData = await response.text();
            calendar.events = parseIcsData(icsData);
        }

        function parseIcsData(icsData) {
            const events = [];
            const lines = icsData.split('\n');
            let currentEvent = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.dtstart && currentEvent.dtend) {
                        currentEvent.startDate = parseIcsDate(currentEvent.dtstart);
                        currentEvent.endDate = parseIcsDate(currentEvent.dtend);
                        currentEvent.isPast = currentEvent.endDate < new Date();
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':');
                    
                    switch (key.split(';')[0]) {
                        case 'DTSTART':
                            currentEvent.dtstart = value;
                            break;
                        case 'DTEND':
                            currentEvent.dtend = value;
                            break;
                        case 'SUMMARY':
                            currentEvent.summary = value;
                            break;
                        case 'DESCRIPTION':
                            currentEvent.description = value;
                            break;
                        case 'LOCATION':
                            currentEvent.location = value;
                            break;
                    }
                }
            }
            
            return events;
        }

        function parseIcsDate(dateString) {
            const cleanDate = dateString.replace(/[TZ]/g, '');
            const year = parseInt(cleanDate.substring(0, 4));
            const month = parseInt(cleanDate.substring(4, 6)) - 1;
            const day = parseInt(cleanDate.substring(6, 8));
            const hour = parseInt(cleanDate.substring(8, 10)) || 0;
            const minute = parseInt(cleanDate.substring(10, 12)) || 0;
            const second = parseInt(cleanDate.substring(12, 14)) || 0;
            
            return new Date(year, month, day, hour, minute, second);
        }

        function setupFilters() {
            const filterSection = document.getElementById('filterSection');
            const filterButtons = document.getElementById('filterButtons');
            
            // Bouton "Tous"
            const allButton = document.createElement('button');
            allButton.className = 'filter-btn active';
            allButton.textContent = 'Tous';
            allButton.onclick = () => toggleFilter(null);
            filterButtons.appendChild(allButton);
            
            // Boutons pour chaque calendrier
            window.icsCalendars.forEach(calendar => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = calendar.name;
                button.onclick = () => toggleFilter(calendar.name);
                filterButtons.appendChild(button);
            });
            
            filterSection.style.display = 'block';
            updateEventCount();
        }

        function toggleFilter(calendarName) {
            const buttons = document.querySelectorAll('.filter-btn');
            
            if (calendarName === null) {
                // Bouton "Tous" cliqué
                activeFilters.clear();
                buttons.forEach(btn => btn.classList.remove('active'));
                buttons[0].classList.add('active'); // Activer le bouton "Tous"
            } else {
                // Bouton calendrier spécifique cliqué
                buttons[0].classList.remove('active'); // Désactiver "Tous"
                
                const button = Array.from(buttons).find(btn => btn.textContent === calendarName);
                
                if (activeFilters.has(calendarName)) {
                    activeFilters.delete(calendarName);
                    button.classList.remove('active');
                } else {
                    activeFilters.add(calendarName);
                    button.classList.add('active');
                }
                
                // Si aucun filtre actif, réactiver "Tous"
                if (activeFilters.size === 0) {
                    buttons[0].classList.add('active');
                }
            }
            
            renderEvents();
            updateEventCount();
        }

        function getFilteredEvents() {
            if (activeFilters.size === 0) {
                return allEvents;
            }
            return allEvents.filter(event => activeFilters.has(event.calendarName));
        }

        function updateEventCount() {
            const filteredEvents = getFilteredEvents();
            const futureEvents = filteredEvents.filter(event => !event.isPast).length;
            const pastEvents = filteredEvents.filter(event => event.isPast).length;
            
            document.getElementById('eventsCount').textContent = 
                `${filteredEvents.length} événements (${futureEvents} à venir, ${pastEvents} passés)`;
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const filteredEvents = getFilteredEvents();
            
            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="no-events">Aucun événement trouvé</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'events-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Jour</th>
                        <th>Date et Heure</th>
                        <th>Durée</th>
                        <th>Résumé</th>
                        <th>Description</th>
                        <th>Lieu</th>
                        <th>Calendrier</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            filteredEvents.forEach(event => {
                const row = document.createElement('tr');
                if (event.isPast) {
                    row.classList.add('past-event');
                }
                
                const dayOfWeek = getDayOfWeek(event.startDate);
                const dateTime = formatDateTime(event.startDate);
                const duration = formatDuration(event.startDate, event.endDate);
                const summary = event.summary || 'Sans titre';
                const description = event.description || '';
                const location = event.location || '';
                
                row.innerHTML = `
                    <td class="day-column">${dayOfWeek}</td>
                    <td class="datetime-column">${dateTime}</td>
                    <td class="duration-column">${duration}</td>
                    <td class="summary-column">${escapeHtml(summary)}</td>
                    <td class="description-column">${escapeHtml(description)}</td>
                    <td class="location-column">${escapeHtml(location)}</td>
                    <td>${escapeHtml(event.calendarName)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function getDayOfWeek(date) {
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return days[date.getDay()];
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function formatDuration(startDate, endDate) {
            const durationMs = endDate - startDate;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h${minutes > 0 ? ` ${minutes}min` : ''}`;
            } else {
                return `${minutes}min`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('eventsContainer');
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = message;
            container.appendChild(error);
        }
    </script>
</body>
</html>